@{
    ViewBag.Title = "CancerQueueCreate";
    Layout = "~/Views/Shared/_LayoutForTopCancer.cshtml";
}

<style>
    .ColorWhite {
        color: #ffffff;
    }

    table.dataTable thead {
        background-color: #337AB7;
        color: azure;
    }

    .card1 {
        display: flex;
        align-items: center;
        background-color: #DAF8FF;
        padding: 5px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        margin: 10px;
    }

    .card2 {
        display: flex;
        align-items: center;
        background-color: #d7f2d1;
        padding: 5px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        margin: 10px;
    }

    .card3 {
        display: flex;
        align-items: center;
        background-color: #FFC3C3;
        padding: 5px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        margin: 10px;
    }

    .paper {
        background-color: #ffffff;
        padding: 10px;
        margin-bottom: 10px;
        margin: 15px;
        align-items: center;
    }
    text {
        font-family: Sarabun;
        
    }

    text.font-custom {
        font-family: Sarabun;
        font-weight:bold
    }

    span {
        font-family: Sarabun;
    }
        span.font-custom {
            font-family: Sarabun;
            font-weight: bold
        }
    .img {
        width: 30px;
        height: 30px;
    }
</style>

    @* search form *@
    
    <div class="row paper">
        <div class="col-md-4 col-sm-6 col-12">
            <div class="info-box card1">
                <div class="col-md-9 col-sm-9">
                    <span class="info-box-text" style="color: #00C0EF; font-size: 18px">ทั้งหมด</span>
                    <span class="info-box-text" style="font-size:16px"><text class="font-custom" id="txtQueueAll" style="font-size:30px ;font-weight:500"></text> คิวงาน</span>
              
                         
                </div>
                <span class="material-icons" style=" background-color: #00C0EF; color: azure; border-radius: 8px; font-size: 40px; padding: 20px;">
                    person
                </span>


            </div>
        </div>

        <div class="col-md-4 col-sm-6 col-12">
            <div class="info-box card2">
                <div class="col-md-9 col-sm-9">
                    <span class="info-box-text" style="color: #1C7905; font-size: 18px">ไม่มีข้อมูลเฝ้าระวัง</span>
                    <span class="info-box-text" style="font-size:16px"><text class="font-custom" id="txtCountIsNotBeware" style="font-size:30px ;font-weight:500"></text> คิวงาน</span>
                </div>
                <span class="material-icons" style=" background-color: #1C7905; color: azure; border-radius: 8px; font-size: 40px; padding: 20px;">
                    mark_chat_read
                </span>

            </div>
        </div>
        <div class="col-md-4 col-sm-6 col-12">
            <div class="info-box card3 ">
                <div class="col-md-9 col-sm-9">
                    <span class="info-box-text" style="color: #FF0000; font-size: 18px">มีข้อมูลเฝ้าระวัง</span>
                    <span class="info-box-text" style="font-size:16px"><text  class="font-custom" id="txtCountIsBeware" style="font-size:30px ;font-weight:500"></text> คิวงาน</span>
                </div>
                <span class="material-icons" style=" background-color: #FF0000; color: azure; border-radius: 8px; font-size: 40px; padding: 20px;">
                    error
                </span>
            </div>
        </div>
    </div>


    @*<div id="Create_form">
            <div class="box box-info">
                <div class="box-header">
                    <h4 class="box-title">สร้างคิวงาน</h4>
                </div>
                <div class="box-body">
                    <div class="form-group row">
                        <div class="col-sm-6 col-md-offset-1 col-md-3">
                            <label class="control-label" for="">DCR :</label>
                            <input class="form-control datepicker checkcard" id="dtpDCR" name="dtpDCR" data-provide="datepicker" data-date-language="th-th" required readonly disabled />
                        </div>
                        <div class="col-sm-6 col-md-3" style="padding-top:25px">
                            <button type="button" class="btn btn-info" id="btnCancerCreateQueue" name="btnCancerCreateQueue">สร้างคิวงาน</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-12"></div>
                    </div>
                </div>
            </div>
        </div>*@
    @* end form *@

<form action="" method="post" id="fmCreateQueue">




        <div id="Create_form">
            <div class="paper box-info">
                <div class="box-header">
                    <h4 class="box-title">สร้างคิวงาน</h4>
                </div>
                <div class="box-body">
                    <div class="form-group row">
                        <div class="col-sm-6 col-md-offset-1 col-md-3">
                            <label class="control-label" for="">DCR :</label>
                            <input class="form-control datepicker checkcard" id="dtpDCR" name="dtpDCR" data-provide="datepicker" data-date-language="th-th" required readonly disabled />
                        </div>
                        <div class="col-sm-6 col-md-3" style="padding-top:25px">
                            <button type="button" class="btn btn-info" id="btnCancerCreateQueue" name="btnCancerCreateQueue">สร้างคิวงาน</button>
                        </div>
                        <div class="col-sm-6 col-md-3">
                            @*<label class="control-label" for="">เลขApplication:</label>
                                <input type="text" class="form-control" id="txtSearchApp" />*@
                        </div>
                    </div>

                </div>
            </div>
        </div>



        <div id="dt_form">
            <div class="paper box-warning">
                <div class="box-header">
                    <h4 class="box-title">ประวัติการสร้างคิวงาน</h4>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="dtCancerCreateQueueHistory" name="dtCancerCreateQueueHistory" class="table table-bordered table-striped display responsive" style="width: 100%">
                                <tbody>
                                    <tr style="text-align: center"><td>ไม่พบข้อมูล</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!--<div class="col-sm-12 col-md-12">-->
        @* DT form *@
        <!--<div id="dt_form">
            <div class="box box-warning">
                <div class="box-header">
                    <h4 class="box-title">ประวัติการสร้างคิวงาน</h4>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="dtCancerCreateQueueHistory" name="dtCancerCreateQueueHistory" class="table table-bordered table-striped display responsive" style="width: 100%">
                                <tbody>
                                    <tr style="text-align: center"><td>ไม่พบข้อมูล</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>-->
        @* end form *@
  
    <input type="hidden" id="userId" value="@ViewBag.UserId" />
    @* hidden *@
</form>
<div class="modal fade in" id="modal-AreaManager" style="display: none; padding-right: 5px;">
    <div class="modal-dialog modal-lg">
        <div class="box box-primary">
            <div class="modal-header" style="color: #337AB7; padding-left:20px">
                <h4>รายละเอียดคิวงาน</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:black">
                    <span aria-hidden="false">×</span>
                </button>
            </div>
            <div class="box-body">
                <div class="col-md-4 col-sm-6 col-xs-8">
                    <div class="card widget-user">
                        <div class="widget-user-desc bg-primary" style="border-radius: 10px 10px 0px 0px; ">
                            <div class="widget-user" style="font-size:16px; padding:8px">
                                <span>
                                    คิวงานทั้งหมด
                                    <span class="float-right badge pull-right" style="background-color:lightcyan; color:black; margin-right:5px" id="countQueueAll"></span>
                                </span>
                            </div>
                        </div>
                        <div class="card-footer p-0">
                            <ul class="nav flex-column">
                                <li class="nav-item" style="background-color: #e1eafa">
                                    <a href="#" class="nav-link">
                                        ยังไม่ได้ตรวจสอบ <span class="float-right badge bg-yellow pull-right" id="countQueuePending"></span>
                                    </a>
                                </li>
                                <li class="nav-item" style="background-color: #e1eafa ;border-radius: 0px 0px 10px 10px ">
                                    <a href="#" class="nav-link">
                                        ตรวจสอบแล้ว <span class="float-right badge bg-green pull-right" id="countQueueComplete"></span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-12">
                    @* DT form *@
                    <div id="dt_formDetail">
                        <div class="box box-solid">
                            <div class="box-header">
                            </div>
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <table id="dtCreateQueueDetail" name="dtCreateQueueDetail" class="table table-bordered table-hover dataTable" style="width: 100%">
                                            <tbody>
                                                <tr style="text-align: center"><td>ไม่พบข้อมูล</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @* end form *@
                </div>
            </div>
        </div>
    </div>
</div>
@section ViewSpecificJavascript
{
    <script type="text/javascript">
        $(function () {
            DoShowDCR();
            DoShowGrid();
            GetQueueCountCI();
        });

        $('#btnCancerCreateQueue').click(function (e) {
            debugger
            e.preventDefault();
            DoInserNewQueueCI();
        });
        const DoInserNewQueueCI = () => {
            swal({
                title: "",
                text: "ยืนยันสร้างคิวงาน",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-warning",
                confirmButtonText: "ตกลง",
                cancelButtonText: "ยกเลิก",
                closeOnConfirm: false,
                closeOnCancel: true
            },
                function (isConfirm) {
                    if (isConfirm) {
                        InsetNewQueueCI();
                    }
                }
            );
        }

        const InsetNewQueueCI = () => {
            //Check
            $.ajax({
                type: "POST",
                url: '@Url.Action("SaveCancerCreateQueue", "CancerQueue")',
                data: {
                    dcrDate: $('#dtpDCR').val()
                },
                dataType: "json",
                async: false,
                success: function (response) {

                    if (response != null) {
                        if (response[0] == "True") {
                            swal({
                                title: "สำเร็จ",
                                text: response[2],
                                type: "success",
                                showCancelButton: false,
                                showConfirmButton: false,
                                timer: 2000
                            });
                            DoShowGrid();
                        }
                        else { swal("ไม่สำเร็จ", response[2], "error"); }
                        $('#dtCancerCreateQueueHistory').DataTable().ajax.reload();
                        GetQueueCountCI();
                    }
                    else { swal("เกิดข้อผิดพลาด", "ไม่สามารถบันทึกได้" , "error"); }
                },
                error: function (response) {
                    swal("เกิดข้อผิดพลาด", response[2], "error");
                }

            });

        }

        function DoShowDCR() {
            var dateN = new Date();
            if (dateN.getDate() >= 11) {
                dateN.setMonth(dateN.getMonth() + 1);
            }

            dateN.setMonth(dateN.getMonth());

            $('#dtpDCR').datepicker({
                autoclose: true,
                minViewMode: 1,
                format: 'dd/mm/yyyy'
            }).datepicker("setDate", new Date(dateN.getFullYear(), dateN.getMonth(), 1))
                .on('changeDate', function (selected) {
                    startDate = new Date(selected.date.valueOf());
                    startDate.setDate(startDate.getDate(new Date(selected.date.valueOf())));
                    $('.to').datepicker('setStartDate', startDate);
                });
        };

        function DoShowGrid() {
            $('#dtCancerCreateQueueHistory').empty();
            let t = $('#dtCancerCreateQueueHistory').DataTable({
                 pageLength: 10,
                 processing: true,
                 serverSide: true,
                 responsive: true,
                destroy: true,
                searching: false,
                 ajax: {
                     url: '@Url.Action("GetMonitorCancerCreateQueueHistory", "CancerQueue")',
                        type: 'POST',
                     data: function (d) {
                         d.period = $('#dtpDCR').val();
                            d.draw = d.draw;
                            d.pageSize = d.length;
                            d.pageStart = d.start;
                            d.sortField = d.columns[d.order[0].column].data;
                            d.orderType = d.order[0].dir;
                         console.log(d);
                        }
                    },
                    columns: [
                    { titel: 'id', data: "QueueAuditLotId" },
                    {
                        title: 'DCR', data: "Period",
                        render: function (data) {
                            if (data == null) {
                                return "";
                            } else {
                                return moment(data).add(543, 'years').format("DD/MM/YYYY", "LLLL");
                            }

                        }
                    },
                    {
                        title: 'วันที่สร้างคิวงาน', data: 'CreatedDate',
                        render: function (data) {
                            if (data == null) {
                                return "";
                            } else {
                                return moment(data).add(543, 'years').format("DD/MM/YYYY HH:mm:SS", "LLLL");
                            }

                        }
                    },
                        {
                            title: 'ผู้ทำรายการ',
                            data: "CreatedByUser",
                            className: 'h-dt-center'
                        },
                        {
                            title: 'รายละเอียด', data: null, width: '10%',
                            mRender: function (data) {
                                return `<button type="button" class="btn btn-info" onclick="openModalDetailCall(${data.QueueAuditLotId})">รายละเอียด</button>`;
                            }
                    }],
                bLengthChange: false,
                'columnDefs': [
                    {
                        "targets": [0],
                        "visible": false
                    },
                    {
                        "targets": "_all", // your case first column
                        "className": "text-center",
                    }]

                });
        }
          const GetQueueCountCI = () => {
                 $.get("@Url.Action("GetQueueCountCI")", function (data) {
                   
                     if (data.Total != 0) {

                         $("#txtQueueAll").text(data.Total);
                         $("#txtCountIsNotBeware").text(data.CountIsNotBeware);
                         $("#txtCountIsBeware").text(data.CountIsBeware);
                } else {
                         $("#txtQueueAll").text("0");
                         $("#txtCountIsNotBeware").text("0");
                         $("#txtCountIsBeware").text("0");
                }
            })
        }


        const openModalDetailCall = (queueAuditLotId) => {
       
            GetCountCI(queueAuditLotId);
            DataTableCreateQueueDetailCI(queueAuditLotId);
            $('#modal-AreaManager').modal('show');
        }

        const DataTableCreateQueueDetailCI = (queueAuditLotId) => {
             $('#dtCreateQueueDetail').empty();
             var table = $('#dtCreateQueueDetail').DataTable({
                 pageLength: 10,
                 processing: true,
                 serverSide: true,
                 responsive: true,
                destroy: true,
                 searching: false,

                 ajax: {
                     url: '@Url.Action("GetCreateQueueDetail")',
                        type: 'POST',
                     data: function (d) {
                         d.queueAuditLotId = queueAuditLotId;
                            d.draw = d.draw;
                            d.pageSize = d.length;
                            d.pageStart = d.start;
                            d.sortField = d.columns[d.order[0].column].data;
                            d.orderType = d.order[0].dir;
                            d.search = d.search.value;
                        }
                    },
                columns: [

                    {
                        title: 'ขื่อผู้รับผิดชอบ',
                        data: "PersonName",
                        className: 'th-left'
                    },
                    {
                        title: 'คิวงานทั้งหมด',
                        data: "QueueAllCount",
                        className: 'text-center'
                    },
                    {
                        title: 'ยังไม่ได้ตรวจสอบ',
                        data: "QueuePendingCount",
                        className: 'text-center'
                    },
                    {
                        title: 'ตรวจสอบแล้ว',
                        data: "QueueCompleteCount",
                        className: 'text-center'
                    },
                ],
            });
            window.onresize = function () {
                table.columns.adjust().responsive.recalc();
            };
        }




        function GetCountCI(queueAuditLotId) {
 
             $.ajax({
                type: "GET",
               url: '@Url.Action("GetCount")',
                 data: { queueAuditLotId: queueAuditLotId },
                dataType: "json",
                async: false,
                 success: function (data) {
                     var countQueueAll = 0;
                     var countQueuePending = 0;
                     var countQueueComplete = 0;
                     for (var i = 0; i < data.length; i++) {
                         countQueueAll = countQueueAll + data[i].QueueAllCount;
                         countQueuePending = countQueuePending + data[i].QueuePendingCount;
                         countQueueComplete = countQueueComplete + data[i].QueueCompleteCount;
                     }
                     $('#countQueueAll').text(countQueueAll);
                     $('#countQueuePending').text(countQueuePending);
                     $('#countQueueComplete').text(countQueueComplete);
                }
            })
        }
    </script>
}