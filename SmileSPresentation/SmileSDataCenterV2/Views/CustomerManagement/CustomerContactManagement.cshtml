
@{
    ViewBag.Title = "แก้ไขข้อมูลการติดต่อ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<form class="form-horizontal" style="margin-top:10px">

    <div class="row">
        <div class="col-xs-12">
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#NavContact" data-toggle="tab" aria-expanded="true"><h5>แก้ไขข้อมูลการติดต่อ</h5></a></li>
                    <li class=""><a href="#NavHistoryWork" data-toggle="tab" aria-expanded="false"><h5>กรมธรรม์ที่เกี่ยวข้อง</h5></a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="NavContact">
                        <div class="row" style="margin-top:1%">
                            <div class="col-sm-12">
                                <label>ชื่อ-สกุล:</label>
                                <span id="lblNameCustomer"></span>
                            </div>
                        </div>
                        <div class="row" style="margin-top:2%;">
                            <div class="col-lg-12">
                                <div class="box box-default box-solid">
                                    <div class="col-lg-12 box-header with-border" style="background-color: #4ea8d2; color: #ffffff; margin-top: -10px ">
                                        <h3 class="box-title"><i class="glyphicon glyphicon-cog"></i> ข้อมูลการติดต่อ</h3>

                                        <div class="box-tools pull-right">
                                            <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                                <i class="fa fa-chevron-down" style="color:white; min-width:auto; min-height:auto"></i>
                                            </button>
                                        </div>
                                        <!-- /.box-tools -->
                                    </div>
                                    <!-- /.box-header -->
                                    <div class="box-body" style="margin-top:1px">
                                        <div class="row" style="margin-top:4%;">
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-phone"></i>
                                                <label>เบอร์โทรศัพท์หลัก:</label>
                                                <span id="lblMMobileNo"></span>
                                                <input type="text" name="mainMoblieNumber" id="txtMMobileNo" class="form-control" />
                                            </div>
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-phone"></i>
                                                <label>เบอร์โทรศัพท์รอง:</label>
                                                <span id="lblSMobileNo"></span>
                                                <input type="text" name="secordMoblieNumber" id="txtSMobileNo" class="form-control" />
                                            </div>
                                        </div>
                                        <div class="row" style="margin-top:2%">
                                            <div class="col-lg-4">
                                                <label>Email:</label>
                                                <span id="lblEmail"></span>
                                                <input type="text" name="Email" id="txtEmail" class="form-control" />

                                            </div>
                                            <div class="col-lg-4">
                                                <label>ID Line:</label>
                                                <span id="lblIdLine"></span>
                                                <input type="text" name="idLine" id="txtIdLine" class="form-control" />

                                            </div>
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-facebook-square" style="color:darkblue; min-width:auto; min-height:auto"></i>
                                                <label>ID Facebook:</label>
                                                <span id="lblIdFacebook"></span>
                                                <input type="text" name="idFacebook" id="txtIdFacebook" class="form-control" />

                                            </div>
                                        </div>
                                        <div class="row" style="margin-top: 2%; margin-bottom: 2%">
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-twitter" style="color:deepskyblue; min-width:auto; min-height:auto"></i>
                                                <label>ID Twitter:</label>
                                                <span id="lblIdTwitter"></span>
                                                <input type="text" name="idTwitter" id="txtIdTwitter" class="form-control" />

                                            </div>
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-instagram" style="color:#D81B60; min-width: auto; min-height: auto"></i>
                                                <label>ID Instagram:</label>
                                                <span id="lblIdInstagram"></span>
                                                <input type="text" name="idInstagram" id="txtIdInstagram" class="form-control" />

                                            </div>
                                            <div class="col-lg-4">
                                                <i class="fa fa-fw fa-youtube-play" style="color:red; min-width:auto; min-height:auto"></i>
                                                <label>ID Youtube:</label>
                                                <span id="lblIdYoutube"></span>
                                                <input type="text" name="idYoutube" id="txtIdYoutube" class="form-control" />

                                            </div>
                                        </div>
                                    </div>
                                    <!-- /.box-body -->
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top:2%; text-align:center; margin-bottom:2%">
                            <div>
                                <button type="button" id="btnCallConfirm" class="btn bg-olive form-control" style="max-width:10%; border-radius:20px; text-decoration:none; font-size:16px;">
                                    <i class="glyphicon glyphicon-ok"></i>
                                    ตกลง
                                </button>
                                <button type="button" id="btnCancel" class="btn  btn-danger form-control" style="max-width: 10%; margin-left: 3%; border-radius: 20px; text-decoration: none; font-size: 16px;">ยกเลิก</button>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane" id="NavHistoryWork">
                        <div class="row">
                            <div class="col-xs-12">
                                <table id="dtInsurance" class="table table-bordered table-hover dataTable" style="width:100%"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Modal Transactions-->
    <div class="modal fade in" id="modal-TransactionDetail" style="display: none; padding-right: 5px;">
        <div class="modal-dialog" style="width:70%">
            <div class="modal-content">
                <div class="modal-header with-borde text-center" style="text-align: center; background-color: #4bafbf;">
                    <h3 style="color: white; text-align: center; ">กรมธรรม์ที่เกี่ยวข้อง</h3>
                </div>

                <div class="modal-body">
                    <div class="row" style="margin-left:2%; margin-right:2%">
                        <div class="col-xs-12">
                            <table id="dtInsuranceByConfirm" class="table table-bordered table-hover dataTable" style="width:100%"></table>
                        </div>
                    </div>
                    <div class="row" style="margin-top:3%; text-align:center;">
                        <button type="button" id="btnConfirm" class="btn bg-olive form-control" style="max-width:10%; border-radius:20px; text-decoration:none; font-size:16px;">
                            <i class="glyphicon glyphicon-ok"></i>
                            ยืนยัน
                        </button>
                        <button type="button" id="btnCancelModal" class="btn  btn-danger form-control" style="max-width: 10%; margin-left: 3%; border-radius: 20px; text-decoration: none; font-size: 16px;" data-dismiss="modal">ยกเลิก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hdfPersonId" value="@ViewBag.PersonId" />
</form>

@section ViewSpecificJavascript
{
    <script type="text/javascript">


        $(function () {

    //------------------- Call Nomal Function ------------------//
            GetContactCustomer()
            getHistory('dtInsurance')

    //------------------ Tool ID Function ------------------//

            $('#btnCancel').click(function (e) {
                e.preventDefault();
                DoCancelWindow()
            });

            $('#btnCallConfirm').click((e) => {
                if (isValidate()) {
                    e.preventDefault();
                    debugger;
                    getHistory('dtInsuranceByConfirm')
                    $('#modal-TransactionDetail').modal('show');
                }
            });

            $('#btnConfirm').click(function (e) {
                    e.preventDefault();
                    if (isValidate()) {
                        DoConfirm()
                    }
                });


        })

    //---------------------------------- Function Group ----------------------------------//

        const DoConfirm = () => {

            swal({
                title: "ยืนยันการทำรายการ",
                type: "warning",
                confirmButtonText: "ตกลง",
                cancelButtonText: "ยกเลิก",
                showCancelButton: true,
                closeOnConfirm: false,

            },
                function (isDoConfirm) {
                    if (isDoConfirm) {
                        DoUpsert();
                       return true
                    }
                }
            );
        }

        const DoCancelWindow = () => {
            swal({
                title: "ต้องการยกเลิกการทำรายการ",
                type: "warning",
                confirmButtonText: "ตกลง",
                cancelButtonText: "ยกเลิก",
                showCancelButton: true,
                closeOnConfirm: false,

            },
                function (isDoConfirm) {
                    if (isDoConfirm) {
                        window.close()
                    }
                }
            );
        }

    //----------------------------------- Validate Function ------------------------------------//
        function ValidateThai(email) {
            const re = /^[a-zA-Z0-9$\s@@$!&#^-_.+-/]+$/;
            return re.test(String(email).toLowerCase());
        }
        function ValidateCharactorforContact(charactor) {
            const re = /^[a-zA-Z0-9@@]+$/;
            return re.test(String(charactor).toLowerCase());
        }
        function ValidateNumberforContact(phoneNumber) {
            const re = /^[0-9]+$/;
            return re.test(String(phoneNumber).toLowerCase());
        }

        const isValidate = () => {
            let emailOrg = $('#txtEmail').val();

            if ($('#txtMMobileNo').val() == "" || ValidateNumberforContact($('#txtMMobileNo').val()) === false) {
                swal('ตรวจสอบ', 'กรุณากรอก เบอร์โทรศัพท์หลักและจะต้องเป็นตัวเลขเท่านั้น', 'error');
                return false;
            }

            if ($('#txtMMobileNo').val().trim().length != 10) {
                swal('ตรวจสอบ', 'กรุณากรอก เบอร์โทรศัพท์หลักให้ครบ 10 หลัก', 'error');
                return false;
            }

            if (emailOrg != '' && emailOrg != "-") {
                if (validateEmail(emailOrg) === false || ValidateThai(emailOrg) === false) {
                    swal('คำเตือน', 'กรุณาตรวจสอบ อีเมล', 'error');
                    return false;
                }
            }

            if ($('#txtIdLine').val() != '' && $('#txtIdLine').val() != '-') {
                if (ValidateCharactorforContact($('#txtIdLine').val()) === false) {
                    swal('คำเตือน', 'กรุณาตรวจสอบ LineID', 'error');
                    return false;
                }
            }

            if ($('#txtIdInstagram').val() != '' && $('#txtIdInstagram').val() != '-') {
                if (ValidateCharactorforContact($('#txtIdInstagram').val()) === false) {
                    swal('คำเตือน', 'กรุณาตรวจสอบ Instagram', 'error');
                    return false;
                }
            }
            return true
        }
        


    //---------------------------------------- Get Data -----------------------------------------------//
         const GetContactCustomer = () => {

            $.ajax({
                type: "GET",
                url: '@Url.Action("GetContactCustomerById", "CustomerManagement")',
                data: {
                    personId: $('#hdfPersonId').val()
                },
                dataType: "json",
                async: false,
                success: function (res) {
                    $('#lblNameCustomer').text(res.Title + ' ' + res.FirstName + ' ' + res.LastName)
                    $('#txtMMobileNo').val(res.PrimaryPhone)
                    $('#txtSMobileNo').val(res.SecondaryPhone)
                    $('#txtEmail').val(res.Email)
                    $('#txtIdLine').val(res.LineId)
                    $('#txtIdFacebook').val(res.Facebook)
                    $('#txtIdTwitter').val(res.TwitterId)
                    $('#txtIdInstagram').val(res.InstagramId)
                    $('#txtIdYoutube').val(res.YoutubeId)
                }
            });

        }
    //--------------------------------------- Update -----------------------------------------------//
        const DoUpsert = () => {
            $.ajax({
                type: "POST",
                url: "@Url.Action("UpsertCustomerContact")",
                data: {
                    personId: $("#hdfPersonId").val(),
                    primaryPhone: $("#txtMMobileNo").val(),
                    secordaryPhone: $("#txtSMobileNo").val(),
                    otherPhone: $("#txtOMobileNo").val(),
                    email: $("#txtEmail").val(),
                    lineId: $("#txtIdLine").val(),
                    facebookId: $("#txtIdFacebook").val(),
                    twitterId: $("#txtIdTwitter").val(),
                    instagramId: $("#txtIdInstagram").val(),
                    youtubeId: $("#txtIdYoutube").val()
                },
                dataType: "json",
                async: false,
                success: function (response) {
                    if (response.IsResult == true) {

                        
                        swal("แก้ไขสำเร็จ", response.Msg, "success");

                        $('#modal-TransactionDetail').modal('hide');

                        GetContactCustomer()
                        getHistory('dtInsurance')


                    } else {
                        //alert Msg
                        swal("ตรวจสอบข้อมูล", response.Msg, "warning");
                    }

                },
                error: function (err) {
                    debugger;
                    alert(err);
                }
            });
        }
    //--------------------------------------- Data Table -------------------------------------------//

        const getHistory = (name) => {
             debugger
             $(`#${name}`).empty();
             var t = $(`#${name}`).dataTable({
                    pageLength: 10,
                    processing: true,
                    serverSide: true,
                    responsive: true,
                    searching: false,
                    "order": [[0, "desc"]],
                    destroy: true,
                    ajax: {
                    url: '@Url.Action("GetInsuranceTransactionById", "CustomerManagement")',
                    type: 'POST',
                    async: false,
                    data: function (d) {
                        d.draw = d.draw;
                        d.pageSize = d.length;
                        d.indexStart = d.start;
                        d.sortField = d.columns[d.order[0].column].data;
                        d.orderType = d.order[0].dir;
                        d.search = d.search.value;
                        d.personId = $('#hdfPersonId').val();
                        //d.personId = 3397;
                    }
                },
                columns: [
                    {
                        title: 'Application Code',
                        data: null,
                        className: 'h-dt-center d-dt-center ',
                        mRender: (data, type, full) => {
                            return '<a target="_blank" href="' + data.linkOpenDetail + '" >' + data.ApplicationCode + '</a>'
                             }, width: '25%'
                    },
                    { title: 'Paticipant Code', data: 'ParticipantCode', className: 'h-dt-center text-font-small', width: '20%' },
                    { title: 'Product', data: 'ProductTypeDetail', className: 'h-dt-center text-font-small', width: '20%' },
                    { title: 'ประเภทลูกค้า', data: 'CustomerType', className: 'h-dt-center text-font-small', width: '20%' },

                       ],
                       bLengthChange: false,
            });

        }

    </script>

}